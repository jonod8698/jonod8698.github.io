[{"categories":[],"content":"Ad Password Audit","date":"2022-01-21","objectID":"/posts/ad-password-audit/","tags":[],"title":"AD Password Audit","uri":"/posts/ad-password-audit/"},{"categories":[],"content":"Problem Statement Accounts with bad passwords, especially accounts with privileged access are the Achilles heel of an organisation’s security. Traditionally IT has tried to impose “strong password policies” such as “Choose a password with an uppercase letter, a number, a symbol and more than 10 characters”. However, a password like “Summer2020!” satisfies ALL those requirements despite being an immesurably weak password. So, what can we as IT professionals do to reduce bad passwords and mitigate their impact? MFA if possible. Yes, it’s been repeated to the ground but only 57% percent of organisations use MFA. Disable Legacy authentication. Block or limit access to public facing web portals such as OWA, VPN portals and RDweb. Impose rate limiting and lockout periods for incorrect authentication attempts. Dectect password spraying across multiple accounts by creating honey accounts with login hours set to nothing and set your SIEM to alert when a login attempt is made for that account. Audit passwords regularly – I’ll go into more depth later about one way to approach this. Encourage users to use passphrases. Yes, I do know that passphrases are weak against dictionary attacks, but much like online games, effective strategies change with the “meta” – the current state of the game. At the moment, as most organisations have password policies which encourage 8 character passwords with special characters and numbers, that’s what attackers are expecting. Reduce the ways attacks can obtain NTLMv2 hashes for offline cracking. I.e. disable LLNMR and NBT-NS, block port 445 egress, don’t use domain admin accounts to login to user workstations, enable windows credential guard, minimise use of office macros. Password managers – addresses credential reuse and allows for password auditing. I will revisit password managers in another article. ","date":"2022-01-21","objectID":"/posts/ad-password-audit/:1:0","tags":[],"title":"AD Password Audit","uri":"/posts/ad-password-audit/"},{"categories":[],"content":"How to Remediate: Password Auditing One very effective way of assessing the current state of passwords in your organisation is to dump the ntds.dat file and run it against common password lists and masks. Note: depending on your org, this may not be allowed as dumping the ntds.dat file containing all user hashes is risky as if an attacker accesses it, they can guess passwords offline. On a domain controller with an elevated Command Prompt run: ntdsutil \"ac in ntds\" \"ifm\" \"cr fu c:temp\" q q Files will be located in C:\\Windows\\System32\\temp Copy the ntds.dat file to another computer with hashcat installed. Extract the NTLMv2 hashes from the ntds.dat file. impacket-secretsdump -system registry/SYSTEM -ntds \"Active Directory/ntds.dit\" LOCAL -outputfile hashes.txt #another option python3 /opt/impacket/examples/secretsdump.py -system registry/SYSTEM -ntds \"Active Directory/ntds.dit\" LOCAL -outputfile hashes.txt Run hashcat against the hashes.txt file. I had the most success with the “dive.rule” combined with rockyou sudo gzip -d /usr/share/wordlists/rockyou.txt.gz hashcat -m 1000 -a 0 -o cracked.txt hashes.txt /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/dive.rule –force At the end you can use this awesome tool: Domain Password Audit Tool (DPAT) created by Carrie Roberts to summarise the results in a neat HTML report. Using a Kali VM on my laptop I managed to crack 50% of our organisation’s passwords! You wouldn’t believe how many people had passwords like and . It was definitely a worthwhile exercise and was an eye-opener for management. ","date":"2022-01-21","objectID":"/posts/ad-password-audit/:2:0","tags":[],"title":"AD Password Audit","uri":"/posts/ad-password-audit/"},{"categories":[],"content":"Tpot","date":"2022-01-16","objectID":"/posts/tpot/","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Summary Tpotce is an all-in-one honeypot platform with a collection of honeypots and tools for monitoring them. ","date":"2022-01-16","objectID":"/posts/tpot/:1:0","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Requirements 8GB RAM 128GB Disk Space Unfiltered Internet Access Isolated Subnet Promiscious Mode Enabled for fatt, suricata and p0f to work properly Port forward or NAT to the honeypot ","date":"2022-01-16","objectID":"/posts/tpot/:2:0","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Installation Set up is simple as the ISO is prebuilt. Download the latest ISO from Tpotce releases Mount the ISO to a VM and run through the installer. Select “Standard” as an install option. The install should take around 30 minutes. ","date":"2022-01-16","objectID":"/posts/tpot/:3:0","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Network Configuration ","date":"2022-01-16","objectID":"/posts/tpot/:4:0","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Isolated Subnet To prevent attackers from accessing your internal network via the honeypot, you need to create an isolated subnet. In Unifi-land you can create an isolated subnet by: a) setting a different VLAN ID for your isolated network. (Layer 2) b) Enabling Device Isolation which effectively marks the network as a Guest Network and applies Guest Rules. (Layer 3/4) Based on my testing, built-in Guest Rules perform the following: LAN to Guest Allowed Guest to LAN not Allowed Stateful traffic not Allowed DNS requests to anywhere Allowed Unifi Firewalls have 3 types of networks (Internet,LAN,Guest) with 3 types of rules (In, Out, Local). Types of Networks Internet is simple enough. Anything not RFC1918 is considered an Internet network. LAN is any network without Device Isolation enabled. Guest is any network with Device Isolation enabled. Types of Rules This part is a bit tricky as you need to think from the firewall’s perspective. Let’s consider Guest IN rules. These match traffic from the Guest Network IN to the firewall, then to the LAN. Guest OUT is the opposite, any traffic from the firewall OUT to the Guest Network. So LAN to Guest traffic would match Guest OUT rules. Guest LOCAL is more simple. It’s the router interface, i.e. the default gateway. Here instead of allowing default rules which include DNS, ICMP, and RADIUS, I only allow DHCP. ","date":"2022-01-16","objectID":"/posts/tpot/:4:1","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Port Forwarding Ports 1-64000 should be forwarded to tpot. If you need to access the Web UI externally, you can forward ports 64297 and 64294. ","date":"2022-01-16","objectID":"/posts/tpot/:4:2","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Port Mirroring (optional) I use vSphere 6.7U3 with a VDS and use Security Onion 2.3. To mirror traffic to a monitoring interface: Right click the VDS \u003e Configure \u003e Port Mirroring New \u003e Distributed Port Mirroring \u003e Next \u003e Status = Enabled \u003e Set Sampling rate if required \u003e Next. Select the Source Interface \u003e Next Select the Destination Interface \u003e Next Finish ","date":"2022-01-16","objectID":"/posts/tpot/:4:3","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Post-Installation Visit the T-Pot WebUI at https://\u003cIP/FQDN\u003e:64294 and enjoy. ","date":"2022-01-16","objectID":"/posts/tpot/:5:0","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"Troubleshooting I had some routing issues from the TPOT host to my LAN as my internal network uses 192.168.0.0/16 IP range. The route for 192.168.0.0/20 created by TPOT prevented traffic from returning to my LAN so I created another /32 static route for my computer. I think it would be good if TPOT excludes the 192.168.1.0/24 subnet. ","date":"2022-01-16","objectID":"/posts/tpot/:6:0","tags":[],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":[],"content":"MFA1","date":"2022-01-12","objectID":"/posts/mfa1/","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"1. Introduction If your users have Azure AD P1, Microsoft strongly recommends switching from Per-User MFA to Condtional Access for several reasons: Improved User Experience Granular Access Control Delegated Control to Helpdesk ","date":"2022-01-12","objectID":"/posts/mfa1/:1:0","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"2. Why use Conditional Access to apply MFA? ","date":"2022-01-12","objectID":"/posts/mfa1/:2:0","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"2.1 Improved User Experience Conditional Access allows for less MFA prompts https://dirteam.com/sander/2020/06/17/todo-move-from-the-allow-users-to-remember-multi-factor-authentication-on-devices-they-trust-option-to-conditional-access/ https://docs.microsoft.com/en-us/azure/active-directory/authentication/concepts-azure-multi-factor-authentication-prompts-session-lifetime ","date":"2022-01-12","objectID":"/posts/mfa1/:2:1","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"2.2 Granular Access Control Per-User MFA can be turned on or off with no granularity outside of IP range exclusions. Enabling MFA via CA allows for granular control of MFA prompts based on Risk (P2 license), Device status, application, and more. ","date":"2022-01-12","objectID":"/posts/mfa1/:2:2","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"2.3 Delegated Control to Helpdesk Per-User MFA is the legacy PhoneFactor portal. It does not allow for Azure AD RBAC delegation to control MFA through the GUI. ","date":"2022-01-12","objectID":"/posts/mfa1/:2:3","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"3. Test Scenarios Per User MFA and CA policy applied Per User MFA switch from Enforced to Enabled. switch from Enabled to Disabled. Conditional Access MFA Self-Service Password Reset Behaviour for end users. New User Force MFA Force Password Change ","date":"2022-01-12","objectID":"/posts/mfa1/:3:0","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"4. Strategy Corporate owned Windows 10 devices: Enrolled in Intune and compliant Personal owned smartphones (BYOD): Must use an approved client app because MAM policies are deployed with Intune Web browser access from unmanaged devices: MFA is enforced, additionally app enforced restrictions prevent file downloads Guest users are not affected by any rules whereas files shared with them are monitored with cloud app security ","date":"2022-01-12","objectID":"/posts/mfa1/:4:0","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"5. Scripts ","date":"2022-01-12","objectID":"/posts/mfa1/:5:0","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"5.1 Per User MFA Enable/Disable Install Instructions #Requires -Modules MSOnline Connect-MsolService Get-MsolUser | Select-Object UserPrincipalName,StrongAuthenticationMethods,StrongAuthenticationRequirements | Format-Table -AutoSize Links https://www.adaxes.com/script-repository/status-of-users-mfa-in-microsoft-365-s601.htm https://www.adaxes.com/script-repository/check-multi-factor-authentication-status-for-a-user-in-office-365-s556.htm https://www.adaxes.com/script-repository/enabledisable-multi-factor-authentication-for-a-user-in-office-365-s544.htm ","date":"2022-01-12","objectID":"/posts/mfa1/:5:1","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"5.2 Conditional Access MFA ","date":"2022-01-12","objectID":"/posts/mfa1/:5:2","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"5.3 Modify Authentication Methods 5.3.1 Re-register MFA 5.3.2 Revoke MFA 5.3.3 Add Phone Number ","date":"2022-01-12","objectID":"/posts/mfa1/:5:3","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":[],"content":"5.4 Module to export MFA status to CSV See LazyAdmin 5.4.1 Export MFA status to CSV #Requires -Modules MSOnline Connect-MsolService .\\MFAStatus.ps1 | Export-CSV c:\\temp\\UserMFAStatus.csv -noTypeInformation 5.4.3 Filter for users by attributes #Requires -Modules MSOnline Connect-MsolService ## FAQ ### Can Per-user MFA and Conditional MFA be used together? ### Converting from Per-User MFA to Conditional Access MFA","date":"2022-01-12","objectID":"/posts/mfa1/:5:4","tags":["AzureAD","Conditional Access","MFA"],"title":"Multi-Factor Authentication via Conditional Access","uri":"/posts/mfa1/"},{"categories":["other"],"content":"Hugo","date":"2021-12-27","objectID":"/posts/hugo/","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Like many others, I’m sick of using Wordpress. I’ve finally decided to switch to a static site using Hugo. ","date":"2021-12-27","objectID":"/posts/hugo/:0:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Hugo Setup ","date":"2021-12-27","objectID":"/posts/hugo/:1:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Install Hugo I’m using the CodeIT Hugo theme. This requires Hugo Extended. Installation via Chocolatey choco install hugo-extended ","date":"2021-12-27","objectID":"/posts/hugo/:1:1","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Create a new site Hugo will create a new site named \u003cmy-site\u003e hugo new site \u003cmy-site\u003e ","date":"2021-12-27","objectID":"/posts/hugo/:1:2","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Install a theme I like the simplicity and aesthetics of the CodeIT theme. Create a git repository and make the CodeIT repo a submodule of the side directory. cd \u003cmy-site\u003e git init git submodule add https://github.com/sunt-programator/CodeIT.git themes/CodeIT ","date":"2021-12-27","objectID":"/posts/hugo/:1:3","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Configure the site In the root of the site, Hugo will create a config.toml file. Here is an example: contentDir = \"content\" layoutDir = \"layouts\" publishDir = \"public\" buildDrafts = false baseURL = \"https://yoursite.example.com/\" canonifyURLs = true title = \"My Hugo Site\" [taxonomies] category = \"categories\" tag = \"tags\" [params] subtitle = \"Hugo is Absurdly Fast!\" author = \"John Doe\" ","date":"2021-12-27","objectID":"/posts/hugo/:1:4","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Create a new post Hugo will create a new post in the content\\posts directory. All posts are formatted in Markdown. hugo new posts/my-post.md ","date":"2021-12-27","objectID":"/posts/hugo/:1:5","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Run Local Dev Server hugo serve ","date":"2021-12-27","objectID":"/posts/hugo/:1:6","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Deploy to Github Pages Follow the instructions here to create a new Github Pages site. ","date":"2021-12-27","objectID":"/posts/hugo/:2:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Automate Deployment with Github Actions Follow the instructions here to set up a Github Action to build and deploy Hugo sites. ","date":"2021-12-27","objectID":"/posts/hugo/:3:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"}]