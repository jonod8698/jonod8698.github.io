[{"categories":["Security"],"content":"Remote Credential Guard","date":"2022-03-19","objectID":"/posts/remote-credential-guard/","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Summary RCG protects admin credentials by ensuring they are not passed over the network to the target device. ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:1:0","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Details Clients with RCG enabled do not send primary credentials to the target machine. This mitigates the risk of stolen credentials if the target is compromised. In RCG, the client LSA acts as a reverse proxy for ticket requests from the target. Hence, the target never needs to store primary credentials. RCG will not allow NTLM fallback. The flow goes something like this (very simplified): App on target (server) needs a ticket so it asks LSA. LSA opens a channel back to the client LSA. Target LSA asks client LSA to ask for a ticket. Client LSA forwards ticket to Target LSA. ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:2:0","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Limitations Native RDP client only uses logged in user credentials. Devolutions Remote Desktop Manager can use saved credentials. While TGT is encrypted, service tickets are not. If an RDP sesion is initiated to a compromised target or an attacker comrpomises the target while an admin is logged in, the attacker could use the open channel to create sessions on the user’s behalf. “Windows Defender Remote Credential Guard can be used only when connecting to a device that is joined to a Windows Server Active Directory domain, including AD domain-joined servers that run as Azure virtual machines (VMs). Windows Defender Remote Credential Guard cannot be used when connecting to remote devices joined to Azure Active Directory.” “Windows Defender Remote Credential Guard does not support compound authentication. For example, if you’re trying to access a file server from a remote host that requires a device claim, access will be denied.” “Remote Desktop Credential Guard only works with the RDP protocol.” ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:3:0","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Implementation ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:4:0","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Requirements Client must: run Windows 10 or Server 2016+ use Kerberos authentication to connect to the target. Server must: run Windows 10 or Server 2016+ Allow Restricted Admin connections Allow Remote Desktop Connections for the user. Allow delegation of non-exportable credentials. (using derivative credentials on a device other than the one it was produced on) ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:4:1","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Instructions Client Ensure the client uses RCG when initating an RDP session: via GPO: From the Group Policy Management Console, go to Computer Configuration -\u003e Administrative Templates -\u003e System -\u003e Credentials Delegation. ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:4:2","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Set policy to one of the following depending on requirements: with a parameter mstsc.exe /remoteGuard Target Server Set reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v DisableRestrictedAdmin /d 0 /t REG_DWORD ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:5:0","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":["Security"],"content":"Links Windows Defender Remote Credential Guard - Microsoft Docs How Authentication Works when you use Remote Desktop - Steve Syfus “No more Pass-the-Hash” – Exploring the limitations of Remote Credential Guard - Cyber Ark) Implement RCG LAB - Github Microsoft ","date":"2022-03-19","objectID":"/posts/remote-credential-guard/:6:0","tags":["Remote Credential Guard","Kerberos"],"title":"Remote Credential Guard","uri":"/posts/remote-credential-guard/"},{"categories":[],"content":"Stormspotter","date":"2022-01-25","objectID":"/posts/stormspotter/","tags":[],"title":"Stormspotter","uri":"/posts/stormspotter/"},{"categories":[],"content":"Introduction Stomspotter is an Azure Red Team tool to graph Azure and Azure AD objects. By mapping out relationships between objects, Stormspotter visualises the attack paths between Azure objects. Warning Stormspotter currently only supports Neo4j 3.x.x. I recommend setting image: neo4j:3.5.18 in your docker-compose.yml ","date":"2022-01-25","objectID":"/posts/stormspotter/:1:0","tags":[],"title":"Stormspotter","uri":"/posts/stormspotter/"},{"categories":[],"content":"Requirements Docker Docker Compose Python 3.8.X Az PowerShell ","date":"2022-01-25","objectID":"/posts/stormspotter/:2:0","tags":[],"title":"Stormspotter","uri":"/posts/stormspotter/"},{"categories":[],"content":"Installation Installation via Docker to avoid manual installation of dependencies. The docker-compose file creates three containers: Frontend Backend Neo4j git clone https://github.com/Azure/Stormspotter cd Stormspotter docker-compose up -d Stormspotter Frontend will expose a WebUI on port 9091. Neo4j will be exposed on port 7474 (HTTP) amd 7687 (Bolt). Default credentials are specified in the docker-compose file. These should be changed. ","date":"2022-01-25","objectID":"/posts/stormspotter/:3:0","tags":[],"title":"Stormspotter","uri":"/posts/stormspotter/"},{"categories":[],"content":"Execution ","date":"2022-01-25","objectID":"/posts/stormspotter/:4:0","tags":[],"title":"Stormspotter","uri":"/posts/stormspotter/"},{"categories":[],"content":"Stormcollector Download the relevant package from Stormspotter Releases Login via az login --allow-no-subscriptions Execute the stormcollector pyz file to collect Azure objects. cd stormcollector python3 sscollector.pyz cli Locate the output in the stormcollector folder with the pyz file. Upload to StormCollector UI Check logs in backend to see processing status Complete. Enjoy! ","date":"2022-01-25","objectID":"/posts/stormspotter/:4:1","tags":[],"title":"Stormspotter","uri":"/posts/stormspotter/"},{"categories":["Security"],"content":"Ad Password Audit","date":"2022-01-21","objectID":"/posts/ad-password-audit/","tags":["AD","Identity"],"title":"AD Password Audit","uri":"/posts/ad-password-audit/"},{"categories":["Security"],"content":"Problem Statement Accounts with bad passwords, especially accounts with privileged access are the Achilles heel of an organisation’s security. Traditionally IT has tried to impose “strong password policies” such as “Choose a password with an uppercase letter, a number, a symbol and more than 10 characters”. However, a password like “Summer2020!” satisfies ALL those requirements despite being an immesurably weak password. So, what can we as IT professionals do to reduce bad passwords and mitigate their impact? MFA if possible. Yes, it’s been repeated to the ground but only 57% percent of organisations use MFA. Disable Legacy authentication. Block or limit access to public facing web portals such as OWA, VPN portals and RDweb. Impose rate limiting and lockout periods for incorrect authentication attempts. Dectect password spraying across multiple accounts by creating honey accounts with login hours set to nothing and set your SIEM to alert when a login attempt is made for that account. Audit passwords regularly – I’ll go into more depth later about one way to approach this. Encourage users to use passphrases. Yes, I do know that passphrases are weak against dictionary attacks, but much like online games, effective strategies change with the “meta” – the current state of the game. At the moment, as most organisations have password policies which encourage 8 character passwords with special characters and numbers, that’s what attackers are expecting. Reduce the ways attacks can obtain NTLMv2 hashes for offline cracking. I.e. disable LLNMR and NBT-NS, block port 445 egress, don’t use domain admin accounts to login to user workstations, enable windows credential guard, minimise use of office macros. Password managers – addresses credential reuse and allows for password auditing. I will revisit password managers in another article. Implement Password Policies through technical controls and company policies. Lithnet Password Protection and Azure AD Password Protection are both great solutions. ","date":"2022-01-21","objectID":"/posts/ad-password-audit/:1:0","tags":["AD","Identity"],"title":"AD Password Audit","uri":"/posts/ad-password-audit/"},{"categories":["Security"],"content":"How to Remediate: Password Auditing One very effective way of assessing the current state of passwords in your organisation is to dump the ntds.dit file and run it against common password lists and masks. Note: depending on your org, this may not be allowed as dumping the ntds.dit file containing all user hashes is risky as if an attacker accesses it, they can guess passwords offline. On a domain controller with an elevated Command Prompt run: ntdsutil \"ac in ntds\" \"ifm\" \"cr fu c:temp\" q q Files will be located in C:\\Windows\\System32\\temp Copy the ntds.dit file to another computer with hashcat installed. Extract the NTLMv2 hashes from the ntds.dat file. impacket-secretsdump -system registry/SYSTEM -ntds \"Active Directory/ntds.dit\" LOCAL -outputfile hashes.txt #another option python3 /opt/impacket/examples/secretsdump.py -system registry/SYSTEM -ntds \"Active Directory/ntds.dit\" LOCAL -outputfile hashes.txt Run hashcat against the hashes.txt file. I had the most success with the “dive.rule” combined with rockyou sudo gzip -d /usr/share/wordlists/rockyou.txt.gz hashcat -m 1000 -a 0 -o cracked.txt hashes.txt /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/dive.rule –force Windows .\\hashcat.exe -m 1000 -a 0 -o .\\cracked.txt .\\hashes.txt .\\rockyou.txt -r .\\dive.rule -O At the end you can use this awesome tool: Domain Password Audit Tool (DPAT) created by Carrie Roberts to summarise the results in a neat HTML report. python3 ./dpat.py -n hashes.txt -c hashcat.potfile -o report.html Using a Kali VM on my laptop I managed to crack 50% of our organisation’s passwords! You wouldn’t believe how many people had passwords like \u003cSeason\u003e\u003cYear\u003e and \u003ccompany name\u003e\u003cnumber\u003e. It was definitely a worthwhile exercise and was an eye-opener for management. ","date":"2022-01-21","objectID":"/posts/ad-password-audit/:2:0","tags":["AD","Identity"],"title":"AD Password Audit","uri":"/posts/ad-password-audit/"},{"categories":["Security"],"content":"Tpot","date":"2022-01-16","objectID":"/posts/tpot/","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Summary Tpotce is an all-in-one honeypot platform with a collection of honeypots and tools for monitoring them. ","date":"2022-01-16","objectID":"/posts/tpot/:1:0","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Requirements 8GB RAM 128GB Disk Space Unfiltered Internet Access Isolated Subnet Promiscious Mode Enabled for fatt, suricata and p0f to work properly Port forward or NAT to the honeypot ","date":"2022-01-16","objectID":"/posts/tpot/:2:0","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Installation Set up is simple as the ISO is prebuilt. Download the latest ISO from Tpotce releases Mount the ISO to a VM and run through the installer. Select “Standard” as an install option. The install should take around 30 minutes. ","date":"2022-01-16","objectID":"/posts/tpot/:3:0","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Network Configuration ","date":"2022-01-16","objectID":"/posts/tpot/:4:0","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Isolated Subnet To prevent attackers from accessing your internal network via the honeypot, you need to create an isolated subnet. In Unifi-land you can create an isolated subnet by: a) setting a different VLAN ID for your isolated network. (Layer 2) b) Enabling Device Isolation which effectively marks the network as a Guest Network and applies Guest Rules. (Layer 3/4) Based on my testing, built-in Guest Rules perform the following: LAN to Guest Allowed Guest to LAN not Allowed Stateful traffic not Allowed DNS requests to anywhere Allowed Unifi Firewalls have 3 types of networks (Internet,LAN,Guest) with 3 types of rules (In, Out, Local). Types of Networks Internet is simple enough. Anything not RFC1918 is considered an Internet network. LAN is any network without Device Isolation enabled. Guest is any network with Device Isolation enabled. Types of Rules This part is a bit tricky as you need to think from the firewall’s perspective. Let’s consider Guest IN rules. These match traffic from the Guest Network IN to the firewall, then to the LAN. Guest OUT is the opposite, any traffic from the firewall OUT to the Guest Network. So LAN to Guest traffic would match Guest OUT rules. Guest LOCAL is more simple. It’s the router interface, i.e. the default gateway. Here instead of allowing default rules which include DNS, ICMP, and RADIUS, I only allow DHCP. ","date":"2022-01-16","objectID":"/posts/tpot/:4:1","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Port Forwarding Ports 1-64000 should be forwarded to tpot. If you need to access the Web UI externally, you can forward ports 64297 and 64294. ","date":"2022-01-16","objectID":"/posts/tpot/:4:2","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Port Mirroring (optional) I use vSphere 6.7U3 with a VDS and use Security Onion 2.3. To mirror traffic to a monitoring interface: Right click the VDS \u003e Configure \u003e Port Mirroring New \u003e Distributed Port Mirroring \u003e Next \u003e Status = Enabled \u003e Set Sampling rate if required \u003e Next. Select the Source Interface \u003e Next Select the Destination Interface \u003e Next Finish ","date":"2022-01-16","objectID":"/posts/tpot/:4:3","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Post-Installation Visit the T-Pot WebUI at https://\u003cIP/FQDN\u003e:64294 and enjoy. ","date":"2022-01-16","objectID":"/posts/tpot/:5:0","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["Security"],"content":"Troubleshooting I had some routing issues from the TPOT host to my LAN as my internal network uses 192.168.0.0/16 IP range. The route for 192.168.0.0/20 created by TPOT prevented traffic from returning to my LAN so I created another /32 static route for my computer. I think it would be good if TPOT excludes the 192.168.1.0/24 subnet. ","date":"2022-01-16","objectID":"/posts/tpot/:6:0","tags":["Honeypot"],"title":"Creating a Honeypot with T-Pot","uri":"/posts/tpot/"},{"categories":["other"],"content":"Hugo","date":"2021-12-27","objectID":"/posts/hugo/","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Like many others, I’m sick of using Wordpress. I’ve finally decided to switch to a static site using Hugo. ","date":"2021-12-27","objectID":"/posts/hugo/:0:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Hugo Setup ","date":"2021-12-27","objectID":"/posts/hugo/:1:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Install Hugo I’m using the CodeIT Hugo theme. This requires Hugo Extended. Installation via Chocolatey choco install hugo-extended ","date":"2021-12-27","objectID":"/posts/hugo/:1:1","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Create a new site Hugo will create a new site named \u003cmy-site\u003e hugo new site \u003cmy-site\u003e ","date":"2021-12-27","objectID":"/posts/hugo/:1:2","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Install a theme I like the simplicity and aesthetics of the CodeIT theme. Create a git repository and make the CodeIT repo a submodule of the side directory. cd \u003cmy-site\u003e git init git submodule add https://github.com/sunt-programator/CodeIT.git themes/CodeIT ","date":"2021-12-27","objectID":"/posts/hugo/:1:3","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Configure the site In the root of the site, Hugo will create a config.toml file. Here is an example: contentDir = \"content\" layoutDir = \"layouts\" publishDir = \"public\" buildDrafts = false baseURL = \"https://yoursite.example.com/\" canonifyURLs = true title = \"My Hugo Site\" [taxonomies] category = \"categories\" tag = \"tags\" [params] subtitle = \"Hugo is Absurdly Fast!\" author = \"John Doe\" ","date":"2021-12-27","objectID":"/posts/hugo/:1:4","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Create a new post Hugo will create a new post in the content\\posts directory. All posts are formatted in Markdown. hugo new posts/my-post.md ","date":"2021-12-27","objectID":"/posts/hugo/:1:5","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Run Local Dev Server hugo serve ","date":"2021-12-27","objectID":"/posts/hugo/:1:6","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Deploy to Github Pages Follow the instructions here to create a new Github Pages site. ","date":"2021-12-27","objectID":"/posts/hugo/:2:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"},{"categories":["other"],"content":"Automate Deployment with Github Actions Follow the instructions here to set up a Github Action to build and deploy Hugo sites. ","date":"2021-12-27","objectID":"/posts/hugo/:3:0","tags":["knowledge-management","static-site"],"title":"Hugo","uri":"/posts/hugo/"}]