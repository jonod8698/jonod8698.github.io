<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SentinelQueriesKQL | Jdsec</title>
<meta name=keywords content="KQL"><meta name=description content="SentinelQueriesKQL"><meta name=author content="JD"><link rel=canonical href=https://technologify.net/posts/security/sentinelquerieskql/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://technologify.net/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="SentinelQueriesKQL"><meta property="og:description" content="SentinelQueriesKQL"><meta property="og:type" content="article"><meta property="og:url" content="https://technologify.net/posts/security/sentinelquerieskql/"><meta property="og:image" content="https://technologify.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-15T19:35:07+11:00"><meta property="article:modified_time" content="2022-03-15T19:35:07+11:00"><meta property="og:site_name" content="Jdsec"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://technologify.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="SentinelQueriesKQL"><meta name=twitter:description content="SentinelQueriesKQL"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://technologify.net/posts/"},{"@type":"ListItem","position":2,"name":"SentinelQueriesKQL","item":"https://technologify.net/posts/security/sentinelquerieskql/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SentinelQueriesKQL","name":"SentinelQueriesKQL","description":"SentinelQueriesKQL","keywords":["KQL"],"articleBody":"Identity Queries Detect Users in an OU not in an Azure AD Group Let’s say you need to find out which AD users are in an OU but not in an Azure AD group. You can use the following query to find the users in the OU but not in the group:\nIdentityInfo | where OnPremisesDistinguishedName endswith_cs \"OU=COMPANY,OU=STORES,OU=CONTOSO,DC=LOCAL\" | where GroupMembership !contains \"Company Store Users\" Detect Users using Office Resources on Personal Devices Identify users logging in from non company devices. Define company device as Azure AD joined or Hybrid AD joined.\nunion AADNonInteractiveUserSignInLogs,SigninLogs | where Identity !startswith_cs \"Franchise Store\" | where AppDisplayName != \"Outlook Mobile\" | where IPAddress !in (,) // equinix new ip | where DeviceDetail_string !contains \"Azure AD\" | where DeviceDetail_dynamic !contains \"Azure AD\" | where DeviceDetail_string !contains_cs \"Ios\" | where DeviceDetail_string !contains \"Android\" | where DeviceDetail_string !contains \"MacOs\" | where NetworkLocationDetails !contains_cs \"Zscaler\" | summarize count() by Identity,IPAddress,Location,DeviceDetail_string MFA prompt vs satisfied //Visualize when your users are actively challenged for MFA vs when it was previously satisfied SigninLogs | where TimeGenerated \u003e ago(365d) | where AuthenticationRequirement == \"multiFactorAuthentication\" | extend x=todynamic(AuthenticationDetails) | mv-expand x | project TimeGenerated, x | extend MFAResultStep = tostring(x.authenticationStepResultDetail) | summarize MFARequired=countif(MFAResultStep == \"MFA completed in Azure AD\"), PreviouslySatisfied=countif(MFAResultStep == \"MFA requirement satisfied by claim in the token\") by bin(TimeGenerated, 1d) | render timechart with ( xtitle=\"Day\", ytitle=\"Count\", title=\"MFA challenges vs MFA previously satisfied over time\") Apps with no signins in last month Can be used for cleanup or detect apps bypassing SSO\n//Find Azure AD applications that have had no signins for over 30 days. May be a sign of an app no longer in use or users bypassing SSO. SigninLogs | where TimeGenerated \u003e ago (365d) | where ResultType == 0 | summarize arg_max(TimeGenerated, *) by AppId | project AppDisplayName, ['Last Logon Time']=TimeGenerated, ['Days Since Last Logon']=datetime_diff(\"day\", now(), TimeGenerated) | where ['Days Since Last Logon'] \u003e 30 Endpoint Devices without contact //Find devices that have stopped sending network events over the last 30 days, retrieve last event time and calculate the days since last event let timerange=365d; let timeframe=30d; DeviceNetworkEvents | project TimeGenerated, DeviceName | where TimeGenerated \u003e ago(timerange) | summarize arg_max(TimeGenerated, DeviceName) by DeviceName | join kind=leftanti ( DeviceNetworkEvents | project TimeGenerated, DeviceName | where TimeGenerated \u003e ago(timeframe) | summarize arg_max(TimeGenerated, DeviceName) by DeviceName) on DeviceName | extend DaysSinceLastEvent = datetime_diff('day', now(), TimeGenerated) | project DeviceName, DaysSinceLastEvent, LastEventTime=TimeGenerated ","wordCount":"401","inLanguage":"en","datePublished":"2022-03-15T19:35:07+11:00","dateModified":"2022-03-15T19:35:07+11:00","author":{"@type":"Person","name":"JD"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://technologify.net/posts/security/sentinelquerieskql/"},"publisher":{"@type":"Organization","name":"Jdsec","logo":{"@type":"ImageObject","url":"https://technologify.net/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://technologify.net/ accesskey=h title="Home (Alt + H)"><img src=https://technologify.net/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://technologify.net/categories/ title=categories><span>categories</span></a></li><li><a href=https://technologify.net/tags/ title=tags><span>tags</span></a></li><li><a href=https://technologify.net/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://technologify.net/>Home</a>&nbsp;»&nbsp;<a href=https://technologify.net/posts/>Posts</a></div><h1 class=post-title>SentinelQueriesKQL</h1><div class=post-description>SentinelQueriesKQL</div><div class=post-meta><span title='2022-03-15 19:35:07 +1100 +1100'>15 March, 2022</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;401 words&nbsp;·&nbsp;JD</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#identity-queries aria-label="Identity Queries">Identity Queries</a><ul><li><a href=#detect-users-in-an-ou-not-in-an-azure-ad-group aria-label="Detect Users in an OU not in an Azure AD Group">Detect Users in an OU not in an Azure AD Group</a></li><li><a href=#detect-users-using-office-resources-on-personal-devices aria-label="Detect Users using Office Resources on Personal Devices">Detect Users using Office Resources on Personal Devices</a></li><li><a href=#mfa-prompt-vs-satisfied aria-label="MFA prompt vs satisfied">MFA prompt vs satisfied</a></li><li><a href=#apps-with-no-signins-in-last-month aria-label="Apps with no signins in last month">Apps with no signins in last month</a></li></ul></li><li><a href=#endpoint aria-label=Endpoint>Endpoint</a><ul><li><a href=#devices-without-contact aria-label="Devices without contact">Devices without contact</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=identity-queries>Identity Queries<a hidden class=anchor aria-hidden=true href=#identity-queries>#</a></h2><h3 id=detect-users-in-an-ou-not-in-an-azure-ad-group>Detect Users in an OU not in an Azure AD Group<a hidden class=anchor aria-hidden=true href=#detect-users-in-an-ou-not-in-an-azure-ad-group>#</a></h3><p>Let&rsquo;s say you need to find out which AD users are in an OU but not in an Azure AD group. You can use the following query to find the users in the OU but not in the group:</p><pre tabindex=0><code class=language-kql data-lang=kql>IdentityInfo
| where OnPremisesDistinguishedName endswith_cs &#34;OU=COMPANY,OU=STORES,OU=CONTOSO,DC=LOCAL&#34;
| where GroupMembership !contains &#34;Company Store Users&#34;
</code></pre><h3 id=detect-users-using-office-resources-on-personal-devices>Detect Users using Office Resources on Personal Devices<a hidden class=anchor aria-hidden=true href=#detect-users-using-office-resources-on-personal-devices>#</a></h3><p>Identify users logging in from non company devices. Define company device as Azure AD joined or Hybrid AD joined.</p><pre tabindex=0><code>union AADNonInteractiveUserSignInLogs,SigninLogs
| where Identity !startswith_cs &#34;Franchise Store&#34;
| where AppDisplayName != &#34;Outlook Mobile&#34;
| where IPAddress !in (&lt;IP 1&gt;,&lt;IP 2&gt;) // equinix new ip
| where DeviceDetail_string !contains &#34;Azure AD&#34;
| where DeviceDetail_dynamic !contains &#34;Azure AD&#34;
| where DeviceDetail_string !contains_cs &#34;Ios&#34;
| where DeviceDetail_string !contains &#34;Android&#34;
| where DeviceDetail_string !contains &#34;MacOs&#34;
| where NetworkLocationDetails !contains_cs &#34;Zscaler&#34;
| summarize count() by Identity,IPAddress,Location,DeviceDetail_string
</code></pre><h3 id=mfa-prompt-vs-satisfied>MFA prompt vs satisfied<a hidden class=anchor aria-hidden=true href=#mfa-prompt-vs-satisfied>#</a></h3><pre tabindex=0><code>//Visualize when your users are actively challenged for MFA vs when it was previously satisfied
SigninLogs
| where TimeGenerated &gt; ago(365d)
| where AuthenticationRequirement == &#34;multiFactorAuthentication&#34;
| extend x=todynamic(AuthenticationDetails)
| mv-expand x
| project TimeGenerated, x
| extend MFAResultStep = tostring(x.authenticationStepResultDetail)
| summarize
    MFARequired=countif(MFAResultStep == &#34;MFA completed in Azure AD&#34;),
    PreviouslySatisfied=countif(MFAResultStep == &#34;MFA requirement satisfied by claim in the token&#34;)
    by bin(TimeGenerated, 1d)
| render timechart
    with (
    xtitle=&#34;Day&#34;,
    ytitle=&#34;Count&#34;,
    title=&#34;MFA challenges vs MFA previously satisfied over time&#34;)
</code></pre><h3 id=apps-with-no-signins-in-last-month>Apps with no signins in last month<a hidden class=anchor aria-hidden=true href=#apps-with-no-signins-in-last-month>#</a></h3><p>Can be used for cleanup or detect apps bypassing SSO</p><pre tabindex=0><code>//Find Azure AD applications that have had no signins for over 30 days. May be a sign of an app no longer in use or users bypassing SSO.
SigninLogs
| where TimeGenerated &gt; ago (365d)
| where ResultType == 0
| summarize arg_max(TimeGenerated, *) by AppId
| project
    AppDisplayName,
    [&#39;Last Logon Time&#39;]=TimeGenerated,
    [&#39;Days Since Last Logon&#39;]=datetime_diff(&#34;day&#34;, now(), TimeGenerated)
| where [&#39;Days Since Last Logon&#39;] &gt; 30
</code></pre><h2 id=endpoint>Endpoint<a hidden class=anchor aria-hidden=true href=#endpoint>#</a></h2><h3 id=devices-without-contact>Devices without contact<a hidden class=anchor aria-hidden=true href=#devices-without-contact>#</a></h3><pre tabindex=0><code>//Find devices that have stopped sending network events over the last 30 days, retrieve last event time and calculate the days since last event
let timerange=365d;
let timeframe=30d;
DeviceNetworkEvents
| project TimeGenerated, DeviceName
| where TimeGenerated &gt; ago(timerange)
| summarize arg_max(TimeGenerated, DeviceName) by DeviceName
| join kind=leftanti (
    DeviceNetworkEvents
    | project TimeGenerated, DeviceName
    | where TimeGenerated &gt; ago(timeframe)
    | summarize arg_max(TimeGenerated, DeviceName) by DeviceName)
    on DeviceName
| extend DaysSinceLastEvent = datetime_diff(&#39;day&#39;, now(), TimeGenerated)
| project DeviceName, DaysSinceLastEvent, LastEventTime=TimeGenerated
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://technologify.net/tags/kql/>KQL</a></li></ul><nav class=paginav><a class=prev href=https://technologify.net/posts/security/remote-credential-guard/><span class=title>« Prev</span><br><span>Remote Credential Guard</span>
</a><a class=next href=https://technologify.net/posts/draft/stormspotter/><span class=title>Next »</span><br><span>Stormspotter</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://technologify.net/>Jdsec</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>