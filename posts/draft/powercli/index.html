<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Automating vSphere with PowerCLI | JDTech</title>
<meta name=keywords content><meta name=description content="Powercli"><meta name=author content="JD"><link rel=canonical href=https://technologify.net/posts/draft/powercli/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.857f9fea0402425c5de58e9bd520d541b58a979a2ee014453c6d6b69c2ba3aec.css integrity="sha256-hX+f6gQCQlxd5Y6b1SDVQbWKl5ou4BRFPG1racK6Ouw=" rel="preload stylesheet" as=style><noscript><link crossorigin=anonymous href=/css/includes/noscript.30127fa68e36d08f5dd7f9d4e717dac42e729b844672afd0fbcacb0d9e508595.css integrity="sha256-MBJ/po420I9d1/nU5xfaxC5ym4RGcq/Q+8rLDZ5QhZU=" rel="preload stylesheet" as=style></noscript><link rel=icon href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://technologify.net/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://technologify.net/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-4","auto"),ga("send","pageview"))</script><meta property="og:title" content="Automating vSphere with PowerCLI"><meta property="og:description" content="Powercli"><meta property="og:type" content="article"><meta property="og:url" content="https://technologify.net/posts/draft/powercli/"><meta property="og:image" content="https://technologify.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-31T18:57:18+10:00"><meta property="article:modified_time" content="2020-07-31T18:57:18+10:00"><meta property="og:site_name" content="Jonathan's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://technologify.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Automating vSphere with PowerCLI"><meta name=twitter:description content="Powercli"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://technologify.net/posts/"},{"@type":"ListItem","position":2,"name":"Automating vSphere with PowerCLI","item":"https://technologify.net/posts/draft/powercli/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Automating vSphere with PowerCLI","name":"Automating vSphere with PowerCLI","description":"Powercli","keywords":[],"articleBody":"PowerCLI by VMWmare is a tried and tested way of scripting management of a vSphere instance using PowerShell.\nInstalling PowerCLI Open a PowerShell terminal as administrator and run the following commands:\n#Install PowerCLI Install-Module VMware.PowerCLI -AllowClobber -Force #Disable Certificate Verficiation (Don't use this in production) Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Confirm:$false #Disable CEIP Telemetry Set-PowerCLIConfiguration -Scope User -ParticipateInCEIP:$false #Save vSphere credentials New-VICredentialStoreItem -Host \u003cvSphere FQDN or IP\u003e -User \"@domain.com\" -Password \"\" #Test your connection to a vSphere Server Connect-VIServer \u003cvSphere FQDN or IP\u003e Instant Clones An instant clone builds on the advantages of a linked clone by not only sharing common files but also sharing RAM. It’s also parentless too so it’ll still work if the parent VM is deleted.\nA CI/CD-like workload such as Intune application testing hugely benefits from instant clones as instead of reinstalling windows, then waiting to go through OOBE hundreds of times, the process can be automated end-to-end. This is critical for catching issues in the install process before pushing Intune to production.\nSee William Lam’s guide for further details.\nThe basic process is:\nCreate a Template VM. Install programs/windows updates etc. VMWare Tools must be installed.\n“Freeze” the VM using a script. This is to minimise the number of delta disks created.\nRun a script to clone, then “unfreeze” the instant clone.\nWindows Instant Clones Below is a script to “Freeze” Windows 10 VMs. It does not need to be modified as it receives hostname, IP, DNS, Gateway from the next script. This is a bat file that is run on the source/template VM.\n@echo off SET LOGFILE=C:customise-ic-log.txt (call :logit)\u003e\u003e\"%LOGFILE%\" exit /b 0 :logit goto:summary Gets hostname, IP, DNS, Gateway from InstantClone_windows script Requirements: - Windows 10 - Vmware tools installed and running on template VM :summary set PATH=%PATH%;C:Program FilesVMwareVMware Tools set IP_ADDRESS= set HOSTNAME= set HOSTNAME_ORIG= for /f \"skip=2 tokens=3*\" %%A in ('netsh interface show interface') do set INTERFACE_NAME=%%B echo === Start Pre-Freeze === timeout 3 \u003e nul echo === Disabling Network %INTERFACE_NAME% interface ... === ipconfig /release %INTERFACE_NAME% \u003e nul 2\u003e\u00261 netsh interface set interface name=\"%INTERFACE_NAME%\" admin=disable timeout 3 \u003e nul echo === End of Pre-Freeze === timeout 3 \u003e nul echo === Freezing ... === vmtoolsd.exe --cmd \"instantclone.freeze\" timeout 3 \u003e nul echo === Start Post-Freeze when instant clone VM is unfrozen === for /F \"Tokens=*\" %%I in ('vmtoolsd.exe --cmd \"info-get guestinfo.ic.ipaddress\"') do set IP_ADDRESS=%%I for /F \"Tokens=*\" %%J in ('vmtoolsd.exe --cmd \"info-get guestinfo.ic.hostname\"') do set HOSTNAME=%%J for /F \"Tokens=*\" %%G in ('vmtoolsd.exe --cmd \"info-get guestinfo.ic.gateway\"') do set GATEWAY=%%G for /F \"Tokens=*\" %%D in ('vmtoolsd.exe --cmd \"info-get guestinfo.ic.dns\"') do set DNS=%%D for /F \"Tokens=*\" %%K in ('hostname') do set HOSTNAME_ORIG=%%K timeout 1 \u003e nul echo === Updating IP Address ... === admin below means administratively down or up netsh interface set interface name=\"%INTERFACE_NAME%\" admin=enable netsh interface ipv4 set address name=\"%INTERFACE_NAME%\" static %IP_ADDRESS% 255.255.255.0 %GATEWAY% netsh interface ip set dns \"%INTERFACE_NAME%\" static %DNS% \u003e nul 2\u003e\u00261 timeout 2 \u003e nul echo Original Name: %HOSTNAME_ORIG% echo New Name: %HOSTNAME% echo === Updating Hostname ... === wmic computersystem where caption='%HOSTNAME_ORIG%' rename '%HOSTNAME%' \u003e nul 2\u003e\u00261 timeout 4 \u003e nul echo === End of Post-Freeze === timeout 3 \u003e nul echo === Reboot Guest === shutdown -r -t 1 On a computer with PowerCLI installed, run the following script. It depends on William Lam’s InstantClone module\n\u003c# .SYNOPSIS Script to deploy instant clones reused ESXi instant clone script. .NOTES Reference: http://www.virtuallyghetto.com/2018/05/leveraging-instant-clone-in-vsphere-6-7-for-extremely-fast-nested-esxi-provisioning.html #\u003e #This key removes the self-signed cert warning for RDP - don't use it in production. reg add \"HKEY_CURRENT_USERSoftwareMicrosoftTerminal Server Client\" /v \"AuthenticationLevelOverride\" /t \"REG_DWORD\" /d 0 /f Import-Module .InstantClone.psm1 Connect-VIServer \u003cvsphere FQDN or IP\u003e function Show-Menu { param ( [string]$Title = 'Instant Clone Selection' ) Clear-Host Write-Host \"================ $Title ================\" Write-Host \"1: Press '1' for Fresh Win 10 with Local admin account.\" Write-Host \"2: Press '2' for Fresh Win 10 OOBE Autopilot test manual\" Write-Host \"3: Press '3' for Exising POS\" Write-Host \"4: Press '4' for Existing Office User\" Write-Host \"4: Press '5' for Existing Office User\" Write-Host \"5: Press '6' for Win 10 OOBE Autopilot test automatic\" Write-Host \"3: Press '7' for Exising POS - script test\" Write-Host \"4: Press '8' for Existing Office User - script test\" } Show-Menu -Title 'My menu' $selection = Read-host \"Please make a selection\" switch ($selection) { '1' { 'selection 1' $SourceVM = \"Windows 10 Template Fresh\" } '2' { 'selection 2' } '3' { 'selection 3' } '4' { 'selection 4' } } $numOfVMs = 3 $ipNetwork = \"192.168.20\" $ipStartingCount=26 $currentIP=$ipStartingCount $netmask = \"255.255.255.0\" $dns = \"192.168.20.10\" $gw = \"192.168.20.1\" $networktype = \"static\" # static or dhcp ### DO NOT EDIT BEYOND HERE ### $StartTime = Get-Date foreach ($i in 1..$numOfVMs) { $newVMName = \"Windows-20-$currentIP\" # Generate random UUID which will be used to update # ESXi Host \u0026 VSAN Node UUID $uuid = [guid]::NewGuid() # Changing ESXi Host UUID requires format to be in hex $uuidHex = ($uuid.ToByteArray() | %{\"0x{0:x}\" -f $_}) -join \" \" $guestCustomizationValues = @{ \"guestinfo.ic.hostname\" = \"$newVMName\" \"guestinfo.ic.ipaddress\" = \"$ipNetwork.$currentIP\" \"guestinfo.ic.netmask\" = \"$netmask\" \"guestinfo.ic.gateway\" = \"$gw\" \"guestinfo.ic.dns\" = \"$dns\" \"guestinfo.ic.sourcevm\" = \"$SourceVM\" \"guestinfo.ic.networktype\" = \"$networktype\" \"guestinfo.ic.uuid\" = \"$uuid\" \"guestinfo.ic.uuidHex\" = \"$uuidHex\" } Write-Host \"IP Address: $ipNetwork.$currentIP\" $currentIP++ # Create Instant Clone New-InstantClone -SourceVM $SourceVM -DestinationVM $newVMName -CustomizationFields $guestCustomizationValues } $s = 40 #Connect to RDP automatically do { Write-Progress -Activity \"Provisioning... $s\" Start-Sleep 1 $s-- } while ($s -gt 0) foreach ($j in 1..$numOfVMs) { $fullIP = \"192.168.20.$ipStartingCount\" Write-Output \"Connecting to $fullIP\" $Server=$fullIP $User=\"admin\" $Password=\"password1234\" cmdkey /generic:TERMSRV/$Server /user:$User /pass:$Password mstsc /v:$Server Start-sleep 4 $ipStartingCount++ } $EndTime = Get-Date $duration = [math]::Round((New-TimeSpan -Start $StartTime -End $EndTime).TotalSeconds,2) Write-Host -ForegroundColor Cyan \"`nTotal Instant Clones: $numOfVMs\" Write-Host -ForegroundColor Cyan \"StartTime: $StartTime\" Write-Host -ForegroundColor Cyan \" EndTime: $EndTime\" Write-Host -ForegroundColor Green \" Duration: $duration seconds\" Linked Clones Using a parent VM, linked clones use a snapshot based delta disk to create a clone VM.\nLinked clones save disk space as they share the same common base files with their parent VM.\nHowever, linked clones are limited to a chain disk length of 30, still consume a large amount of RAM and are slow to deploy which is why I recommend using [instant clones] which are better in almost every way.\nTo deploy a linked clone, create a template VM and shut it down.\n##Creating SQL Linked Clone from a Parent VM \"SQLMasterVM\" #variables Connect-VIServer vc3.domain.com -User administrator@vsphere.local -Password password123 $OSSpec = Get-OSCustomizationSpec -Name 'Windows10_WS1' $BaseVM = \"OOBE Template\" $LinkedVM = \"WS1_Test2\" # Delete snapshots on the Parent VM Get-Snapshot -VM $BaseVM | Remove-Snapshot -Confirm:$false Start-Sleep -Seconds 2 #Create snapshot New-Snapshot -VM $BaseVM -Name \"Linked-Snapshot\" -Description \"Snapshot for linked clones for $LinkedVM\" #Gather information of the created snapshot $snapshotParent = Get-Snapshot -VM $BaseVM | Select Name $snapshotParent = $snapshotParent.Name Start-Sleep -Seconds 5 #Create Linked Clone referencing snapshot and start the VM. New-VM -Name $LinkedVM -VM $BaseVM -Datastore \"Datastore1\" -VMHost esxi3.domain.com -OSCustomizationSpec $OSSpec -LinkedClone -ReferenceSnapshot $snapshotParent -DiskStorageFormat Thin Start-VM -VM $LinkedVM ","wordCount":"1142","inLanguage":"en","datePublished":"2020-07-31T18:57:18+10:00","dateModified":"2020-07-31T18:57:18+10:00","author":{"@type":"Person","name":"JD"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://technologify.net/posts/draft/powercli/"},"publisher":{"@type":"Organization","name":"JDTech","logo":{"@type":"ImageObject","url":"https://technologify.net/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script crossorigin=anonymous src=/assets/js/theme.b20f95bb4da41ef90a2610a557a7000b2649a3f47282ec571676da6fc0427200.js integrity="sha256-sg+Vu02kHvkKJhClV6cACyZJo/RyguxXFnbab8BCcgA="></script><header class=header><div id=progressBar></div><nav class=nav><div class=logo><a href=https://technologify.net/ accesskey=h title="Home (Alt + H)"><img src=https://technologify.net/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button type=button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><input name=hamburger-input id=hamburger-input type=checkbox aria-label="Navigation Menu">
<label id=hamburger-menu for=hamburger-input></label><div class=overlay></div><ul id=menu><li><a href=https://technologify.net/categories/ title=categories><span>categories</span></a></li><li><a href=https://technologify.net/tags/ title=tags><span>tags</span></a></li><li><a href=https://technologify.net/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://technologify.net/>Home</a>&nbsp;»&nbsp;<a href=https://technologify.net/posts/>Posts</a></div><h1 class=post-title>Automating vSphere with PowerCLI</h1><div class=post-description>Powercli</div><div class=post-meta>&lt;span title='2020-07-31 18:57:18 +1000 +1000'>31 July, 2020&lt;/span>&amp;nbsp;·&amp;nbsp;6 min&amp;nbsp;·&amp;nbsp;1142 words&amp;nbsp;·&amp;nbsp;JD</div><div class=post-meta></div></header><div class=post-content><p>PowerCLI by VMWmare is a tried and tested way of scripting management of a vSphere instance using PowerShell.</p><h2 id=installing-powercli>Installing PowerCLI<a hidden class=anchor aria-hidden=true href=#installing-powercli>#</a></h2><p>Open a PowerShell terminal as administrator and run the following commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c>#Install PowerCLI</span>
</span></span><span class=line><span class=cl><span class=nb>Install-Module</span> <span class=n>VMware</span><span class=p>.</span><span class=py>PowerCLI</span> <span class=n>-AllowClobber</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#Disable Certificate Verficiation (Don&#39;t use this in production)</span>
</span></span><span class=line><span class=cl><span class=nb>Set-PowerCLIConfiguration</span> <span class=n>-InvalidCertificateAction</span> <span class=n>Ignore</span> <span class=n>-Confirm:</span><span class=vm>$false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#Disable CEIP Telemetry</span>
</span></span><span class=line><span class=cl><span class=nb>Set-PowerCLIConfiguration</span> <span class=n>-Scope</span> <span class=n>User</span> <span class=n>-ParticipateInCEIP:</span><span class=vm>$false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#Save vSphere credentials</span>
</span></span><span class=line><span class=cl><span class=nb>New-VICredentialStoreItem</span> <span class=n>-Host</span> <span class=p>&lt;</span><span class=n>vSphere</span> <span class=n>FQDN</span> <span class=n>or</span> <span class=n>IP</span><span class=p>&gt;</span> <span class=n>-User</span> <span class=s2>&#34;&lt;username&gt;@domain.com&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;&lt;password&gt;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#Test your connection to a vSphere Server</span>
</span></span><span class=line><span class=cl><span class=nb>Connect-VIServer</span> <span class=p>&lt;</span><span class=n>vSphere</span> <span class=n>FQDN</span> <span class=n>or</span> <span class=n>IP</span><span class=p>&gt;</span>
</span></span></code></pre></div><h2 id=instant-clones>Instant Clones<a hidden class=anchor aria-hidden=true href=#instant-clones>#</a></h2><p>An instant clone builds on the advantages of a linked clone by not only sharing common files but also sharing RAM. It’s also parentless too so it’ll still work if the parent VM is deleted.</p><p>A CI/CD-like workload such as Intune application testing hugely benefits from instant clones as instead of reinstalling windows, then waiting to go through OOBE hundreds of times, the process can be automated end-to-end. This is critical for catching issues in the install process before pushing Intune to production.</p><p>See <a href=https://www.virtuallyghetto.com/2018/05/leveraging-instant-clone-in-vsphere-6-7-for-extremely-fast-nested-esxi-provisioning.html>William Lam’s guide for further details</a>.</p><p>The basic process is:</p><ol><li><p>Create a Template VM. Install programs/windows updates etc. VMWare Tools must be installed.</p></li><li><p>“Freeze” the VM using a script. This is to minimise the number of delta disks created.</p></li><li><p>Run a script to clone, then “unfreeze” the instant clone.</p></li></ol><h3 id=windows-instant-clones>Windows Instant Clones<a hidden class=anchor aria-hidden=true href=#windows-instant-clones>#</a></h3><p>Below is a script to “Freeze” Windows 10 VMs. It does not need to be modified as it receives hostname, IP, DNS, Gateway from the next script. This is a bat file that is run on the source/template VM.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-batch data-lang=batch><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>SET</span> <span class=nv>LOGFILE</span><span class=p>=</span>C:customise-ic-log.txt
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>call</span> <span class=p>:</span><span class=nl>logit</span><span class=p>)&gt;&gt;</span><span class=s2>&#34;</span><span class=nv>%LOGFILE%</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>exit</span> /b 0
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=p>:</span><span class=nl>logit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>goto</span><span class=p>:</span><span class=nl>summary</span>
</span></span><span class=line><span class=cl>Gets hostname, IP, DNS, Gateway from InstantClone_windows script
</span></span><span class=line><span class=cl>Requirements:
</span></span><span class=line><span class=cl>- Windows 10
</span></span><span class=line><span class=cl>- Vmware tools installed and running on template VM
</span></span><span class=line><span class=cl><span class=p>:</span><span class=nl>summary</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>PATH</span><span class=p>=</span><span class=nv>%PATH%</span>;C:Program FilesVMwareVMware Tools
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>IP_ADDRESS</span><span class=p>=</span>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>HOSTNAME</span><span class=p>=</span>
</span></span><span class=line><span class=cl><span class=k>set</span> <span class=nv>HOSTNAME_ORIG</span><span class=p>=</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/f</span> <span class=s2>&#34;skip=2 tokens=3*&#34;</span> <span class=se>%%</span>A <span class=k>in</span> <span class=p>(</span><span class=s1>&#39;netsh interface show interface&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=k>set</span> <span class=nv>INTERFACE_NAME</span><span class=p>=</span><span class=se>%%</span>B
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> === Start Pre-Freeze ===
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>timeout 3 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> === Disabling Network <span class=nv>%INTERFACE_NAME%</span> interface ... ===
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ipconfig /release <span class=nv>%INTERFACE_NAME%</span> <span class=p>&gt;</span> nul <span class=mi>2</span><span class=p>&gt;&amp;</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>netsh interface set interface name=<span class=s2>&#34;</span><span class=nv>%INTERFACE_NAME%</span><span class=s2>&#34;</span> admin=disable
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>timeout 3 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>echo</span> === End of Pre-Freeze ===
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>timeout 3 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>echo</span> === Freezing ... ===
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>vmtoolsd.exe --cmd <span class=s2>&#34;instantclone.freeze&#34;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>timeout 3 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>echo</span> === Start Post-Freeze when instant clone VM is unfrozen ===
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/F</span> <span class=s2>&#34;Tokens=*&#34;</span> <span class=se>%%</span>I <span class=k>in</span> <span class=p>(</span><span class=s1>&#39;vmtoolsd.exe --cmd &#34;info-get guestinfo.ic.ipaddress&#34;&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=k>set</span> <span class=nv>IP_ADDRESS</span><span class=p>=</span><span class=se>%%</span>I
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/F</span> <span class=s2>&#34;Tokens=*&#34;</span> <span class=se>%%</span>J <span class=k>in</span> <span class=p>(</span><span class=s1>&#39;vmtoolsd.exe --cmd &#34;info-get guestinfo.ic.hostname&#34;&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=k>set</span> <span class=nv>HOSTNAME</span><span class=p>=</span><span class=se>%%</span>J
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/F</span> <span class=s2>&#34;Tokens=*&#34;</span> <span class=se>%%</span>G <span class=k>in</span> <span class=p>(</span><span class=s1>&#39;vmtoolsd.exe --cmd &#34;info-get guestinfo.ic.gateway&#34;&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=k>set</span> <span class=nv>GATEWAY</span><span class=p>=</span><span class=se>%%</span>G
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/F</span> <span class=s2>&#34;Tokens=*&#34;</span> <span class=se>%%</span>D <span class=k>in</span> <span class=p>(</span><span class=s1>&#39;vmtoolsd.exe --cmd &#34;info-get guestinfo.ic.dns&#34;&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=k>set</span> <span class=nv>DNS</span><span class=p>=</span><span class=se>%%</span>D
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/F</span> <span class=s2>&#34;Tokens=*&#34;</span> <span class=se>%%</span>K <span class=k>in</span> <span class=p>(</span><span class=s1>&#39;hostname&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=k>set</span> <span class=nv>HOSTNAME_ORIG</span><span class=p>=</span><span class=se>%%</span>K
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>timeout 1 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>echo</span> === Updating IP Address ... === admin below means administratively down or up
</span></span><span class=line><span class=cl>netsh interface set interface name=<span class=s2>&#34;</span><span class=nv>%INTERFACE_NAME%</span><span class=s2>&#34;</span> admin=enable
</span></span><span class=line><span class=cl>netsh interface ipv4 set address name=<span class=s2>&#34;</span><span class=nv>%INTERFACE_NAME%</span><span class=s2>&#34;</span> static <span class=nv>%IP_ADDRESS%</span> 255.255.255.0 <span class=nv>%GATEWAY%</span>
</span></span><span class=line><span class=cl>netsh interface ip set dns <span class=s2>&#34;</span><span class=nv>%INTERFACE_NAME%</span><span class=s2>&#34;</span> static <span class=nv>%DNS%</span> <span class=p>&gt;</span> nul <span class=mi>2</span><span class=p>&gt;&amp;</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>timeout 2 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl><span class=k>echo</span> Original Name: <span class=nv>%HOSTNAME_ORIG%</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> New Name: <span class=nv>%HOSTNAME%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> === Updating Hostname ... ===
</span></span><span class=line><span class=cl>wmic computersystem where caption=&#39;<span class=nv>%HOSTNAME_ORIG%</span>&#39; rename &#39;<span class=nv>%HOSTNAME%</span>&#39; <span class=p>&gt;</span> nul <span class=mi>2</span><span class=p>&gt;&amp;</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>timeout 4 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>echo</span> === End of Post-Freeze ===
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>timeout 3 <span class=p>&gt;</span> nul
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>echo</span> === Reboot Guest ===
</span></span><span class=line><span class=cl>shutdown -r -t 1
</span></span></code></pre></div><p>On a computer with PowerCLI installed, run the following script. It depends on William Lam’s <a href=https://github.com/vmware/PowerCLI-Example-Scripts/blob/master/Modules/InstantClone/InstantClone.psm1>InstantClone module</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>.SYNOPSIS Script to deploy instant clones reused ESXi instant clone script.
</span></span></span><span class=line><span class=cl><span class=cm>.NOTES  Reference: http://www.virtuallyghetto.com/2018/05/leveraging-instant-clone-in-vsphere-6-7-for-extremely-fast-nested-esxi-provisioning.html
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#This key removes the self-signed cert warning for RDP - don&#39;t use it in production.</span>
</span></span><span class=line><span class=cl><span class=n>reg</span> <span class=n>add</span> <span class=s2>&#34;HKEY_CURRENT_USERSoftwareMicrosoftTerminal Server Client&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=s2>&#34;AuthenticationLevelOverride&#34;</span> <span class=p>/</span><span class=n>t</span> <span class=s2>&#34;REG_DWORD&#34;</span> <span class=p>/</span><span class=n>d</span> <span class=mf>0</span> <span class=p>/</span><span class=n>f</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=p>.</span><span class=py>InstantClone</span><span class=p>.</span><span class=py>psm1</span>
</span></span><span class=line><span class=cl><span class=nb>Connect-VIServer</span> <span class=p>&lt;</span><span class=n>vsphere</span> <span class=n>FQDN</span> <span class=n>or</span> <span class=n>IP</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Show-Menu</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>string</span><span class=p>]</span><span class=nv>$Title</span> <span class=p>=</span> <span class=s1>&#39;Instant Clone Selection&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>Clear-Host</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;================ </span><span class=nv>$Title</span><span class=s2> ================&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;1: Press &#39;1&#39; for Fresh Win 10 with Local admin account.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;2: Press &#39;2&#39; for Fresh Win 10 OOBE Autopilot test manual&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;3: Press &#39;3&#39; for Exising POS&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;4: Press &#39;4&#39; for Existing Office User&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;4: Press &#39;5&#39; for Existing Office User&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;5: Press &#39;6&#39; for Win 10 OOBE Autopilot test automatic&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;3: Press &#39;7&#39; for Exising POS - script test&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;4: Press &#39;8&#39; for Existing Office User - script test&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Show-Menu</span> <span class=n>-Title</span> <span class=s1>&#39;My menu&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>$selection</span> <span class=p>=</span> <span class=nb>Read-host</span> <span class=s2>&#34;Please make a selection&#34;</span>
</span></span><span class=line><span class=cl><span class=k>switch</span> <span class=p>(</span><span class=nv>$selection</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;1&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;selection 1&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$SourceVM</span> <span class=p>=</span> <span class=s2>&#34;Windows 10 Template Fresh&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=s1>&#39;2&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;selection 2&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=s1>&#39;3&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;selection 3&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=s1>&#39;4&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;selection 4&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$numOfVMs</span> <span class=p>=</span> <span class=mf>3</span>
</span></span><span class=line><span class=cl><span class=nv>$ipNetwork</span> <span class=p>=</span> <span class=s2>&#34;192.168.20&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$ipStartingCount</span><span class=p>=</span><span class=mf>26</span>
</span></span><span class=line><span class=cl><span class=nv>$currentIP</span><span class=p>=</span><span class=nv>$ipStartingCount</span>
</span></span><span class=line><span class=cl><span class=nv>$netmask</span> <span class=p>=</span> <span class=s2>&#34;255.255.255.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$dns</span> <span class=p>=</span> <span class=s2>&#34;192.168.20.10&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$gw</span> <span class=p>=</span> <span class=s2>&#34;192.168.20.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$networktype</span> <span class=p>=</span> <span class=s2>&#34;static&#34;</span> <span class=c># static or dhcp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### DO NOT EDIT BEYOND HERE ###</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$StartTime</span> <span class=p>=</span> <span class=nb>Get-Date</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$i</span> <span class=k>in</span> <span class=mf>1</span><span class=p>..</span><span class=nv>$numOfVMs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$newVMName</span> <span class=p>=</span> <span class=s2>&#34;Windows-20-</span><span class=nv>$currentIP</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># Generate random UUID which will be used to update</span>
</span></span><span class=line><span class=cl>    <span class=c># ESXi Host &amp; VSAN Node UUID</span>
</span></span><span class=line><span class=cl>    <span class=nv>$uuid</span> <span class=p>=</span> <span class=p>[</span><span class=no>guid</span><span class=p>]::</span><span class=n>NewGuid</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c># Changing ESXi Host UUID requires format to be in hex</span>
</span></span><span class=line><span class=cl>    <span class=nv>$uuidHex</span> <span class=p>=</span> <span class=p>(</span><span class=nv>$uuid</span><span class=p>.</span><span class=py>ToByteArray</span><span class=p>()</span> <span class=p>|</span> <span class=p>%{</span><span class=s2>&#34;0x{0:x}&#34;</span> <span class=o>-f</span> <span class=nv>$_</span><span class=p>})</span> <span class=n>-join</span> <span class=s2>&#34; &#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$guestCustomizationValues</span> <span class=p>=</span> <span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.hostname&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$newVMName</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.ipaddress&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$ipNetwork</span><span class=s2>.</span><span class=nv>$currentIP</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.netmask&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$netmask</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.gateway&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$gw</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.dns&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$dns</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.sourcevm&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$SourceVM</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.networktype&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$networktype</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.uuid&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$uuid</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;guestinfo.ic.uuidHex&#34;</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$uuidHex</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;IP Address: </span><span class=nv>$ipNetwork</span><span class=s2>.</span><span class=nv>$currentIP</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$currentIP</span><span class=p>++</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># Create Instant Clone</span>
</span></span><span class=line><span class=cl>    <span class=nb>New-InstantClone</span> <span class=n>-SourceVM</span> <span class=nv>$SourceVM</span> <span class=n>-DestinationVM</span> <span class=nv>$newVMName</span> <span class=n>-CustomizationFields</span> <span class=nv>$guestCustomizationValues</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$s</span> <span class=p>=</span> <span class=mf>40</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#Connect to RDP automatically</span>
</span></span><span class=line><span class=cl><span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Progress</span> <span class=n>-Activity</span> <span class=s2>&#34;Provisioning... </span><span class=nv>$s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Start-Sleep</span> <span class=mf>1</span>
</span></span><span class=line><span class=cl>    <span class=nv>$s</span><span class=p>--</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=nv>$s</span> <span class=o>-gt</span> <span class=mf>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$j</span> <span class=k>in</span> <span class=mf>1</span><span class=p>..</span><span class=nv>$numOfVMs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$fullIP</span> <span class=p>=</span> <span class=s2>&#34;192.168.20.</span><span class=nv>$ipStartingCount</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Output</span> <span class=s2>&#34;Connecting to </span><span class=nv>$fullIP</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Server</span><span class=p>=</span><span class=nv>$fullIP</span>
</span></span><span class=line><span class=cl>    <span class=nv>$User</span><span class=p>=</span><span class=s2>&#34;admin&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Password</span><span class=p>=</span><span class=s2>&#34;password1234&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cmdkey</span> <span class=p>/</span><span class=n>generic</span><span class=err>:</span><span class=n>TERMSRV</span><span class=p>/</span><span class=nv>$Server</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=nv>$User</span> <span class=p>/</span><span class=n>pass</span><span class=err>:</span><span class=nv>$Password</span>
</span></span><span class=line><span class=cl>    <span class=n>mstsc</span> <span class=p>/</span><span class=n>v:</span><span class=nv>$Server</span>
</span></span><span class=line><span class=cl>    <span class=nb>Start-sleep</span> <span class=mf>4</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ipStartingCount</span><span class=p>++</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$EndTime</span> <span class=p>=</span> <span class=nb>Get-Date</span>
</span></span><span class=line><span class=cl><span class=nv>$duration</span> <span class=p>=</span> <span class=p>[</span><span class=no>math</span><span class=p>]::</span><span class=n>Round</span><span class=p>((</span><span class=nb>New-TimeSpan</span> <span class=n>-Start</span> <span class=nv>$StartTime</span> <span class=n>-End</span> <span class=nv>$EndTime</span><span class=p>).</span><span class=n>TotalSeconds</span><span class=p>,</span><span class=mf>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=n>-ForegroundColor</span> <span class=n>Cyan</span>  <span class=s2>&#34;</span><span class=se>`n</span><span class=s2>Total Instant Clones: </span><span class=nv>$numOfVMs</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=n>-ForegroundColor</span> <span class=n>Cyan</span>  <span class=s2>&#34;StartTime: </span><span class=nv>$StartTime</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=n>-ForegroundColor</span> <span class=n>Cyan</span>  <span class=s2>&#34;  EndTime: </span><span class=nv>$EndTime</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span> <span class=s2>&#34; Duration: </span><span class=nv>$duration</span><span class=s2> seconds&#34;</span>
</span></span></code></pre></div><h2 id=linked-clones>Linked Clones<a hidden class=anchor aria-hidden=true href=#linked-clones>#</a></h2><p>Using a parent VM, linked clones use a snapshot based delta disk to create a clone VM.</p><p>Linked clones save disk space as they share the same common base files with their parent VM.</p><p>However, linked clones are limited to a chain disk length of 30, still consume a large amount of RAM and are slow to deploy which is why I recommend using [instant clones] which are better in almost every way.</p><p>To deploy a linked clone, create a template VM and shut it down.</p><pre tabindex=0><code>
##Creating SQL Linked Clone from a Parent VM &#34;SQLMasterVM&#34;
#variables
Connect-VIServer vc3.domain.com -User administrator@vsphere.local -Password password123

$OSSpec = Get-OSCustomizationSpec -Name &#39;Windows10_WS1&#39;
$BaseVM = &#34;OOBE Template&#34;
$LinkedVM = &#34;WS1_Test2&#34;

# Delete snapshots on the Parent VM
Get-Snapshot -VM $BaseVM | Remove-Snapshot -Confirm:$false
Start-Sleep -Seconds 2

#Create snapshot
New-Snapshot -VM $BaseVM -Name &#34;Linked-Snapshot&#34; -Description &#34;Snapshot for linked clones for $LinkedVM&#34;
 
#Gather information of the created snapshot
$snapshotParent = Get-Snapshot -VM $BaseVM | Select Name
$snapshotParent = $snapshotParent.Name
Start-Sleep -Seconds 5
 
#Create Linked Clone referencing snapshot and start the VM.
New-VM -Name $LinkedVM -VM $BaseVM -Datastore &#34;Datastore1&#34; -VMHost esxi3.domain.com -OSCustomizationSpec $OSSpec -LinkedClone -ReferenceSnapshot $snapshotParent -DiskStorageFormat Thin
Start-VM -VM $LinkedVM
</code></pre></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://technologify.net/posts/draft/ad-password-audit/><span class=title>« Prev</span><br><span>AD Password Audit</span>
</a><a class=next href=https://technologify.net/posts/draft/tpot/><span class=title>Next »</span><br><span>Creating a Honeypot with T-Pot</span></a></nav><div class=share-buttons><a rel="noopener noreferrer" aria-label="share Automating vSphere with PowerCLI on twitter" href="https://twitter.com/intent/tweet/?text=Automating%20vSphere%20with%20PowerCLI&amp;url=https%3a%2f%2ftechnologify.net%2fposts%2fdraft%2fpowercli%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a rel="noopener noreferrer" aria-label="share Automating vSphere with PowerCLI on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ftechnologify.net%2fposts%2fdraft%2fpowercli%2f&amp;title=Automating%20vSphere%20with%20PowerCLI&amp;summary=Automating%20vSphere%20with%20PowerCLI&amp;source=https%3a%2f%2ftechnologify.net%2fposts%2fdraft%2fpowercli%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a rel="noopener noreferrer" aria-label="share Automating vSphere with PowerCLI on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ftechnologify.net%2fposts%2fdraft%2fpowercli%2f&title=Automating%20vSphere%20with%20PowerCLI"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a rel="noopener noreferrer" aria-label="share Automating vSphere with PowerCLI on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftechnologify.net%2fposts%2fdraft%2fpowercli%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a rel="noopener noreferrer" aria-label="share Automating vSphere with PowerCLI on whatsapp" href="https://api.whatsapp.com/send?text=Automating%20vSphere%20with%20PowerCLI%20-%20https%3a%2f%2ftechnologify.net%2fposts%2fdraft%2fpowercli%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a rel="noopener noreferrer" aria-label="share Automating vSphere with PowerCLI on telegram" href="https://telegram.me/share/url?text=Automating%20vSphere%20with%20PowerCLI&amp;url=https%3a%2f%2ftechnologify.net%2fposts%2fdraft%2fpowercli%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://technologify.net/>JDTech</a></span>
<span>- Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer">Hugo</a> &
        <a href=https://github.com/Wonderfall/hugo-WonderMod/ rel=noopener>WonderMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script defer crossorigin=anonymous src=/assets/js/papermod.7ea300eda6d3653624a576fbc095ccd8a0c2977756acbe5de4114132a72cc7fa.js integrity="sha256-fqMA7abTZTYkpXb7wJXM2KDCl3dWrL5d5BFBMqcsx/o="></script></body></html>