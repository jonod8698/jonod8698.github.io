<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>AD Password Audit - JDTech</title><meta name=description content="Ad Password Audit"><meta property="og:title" content="AD Password Audit">
<meta property="og:description" content="Ad Password Audit">
<meta property="og:type" content="article">
<meta property="og:url" content="https://hugo.technologify.net/posts/ad-password-audit/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-21T21:48:57+11:00">
<meta property="article:modified_time" content="2022-01-21T21:48:57+11:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="AD Password Audit">
<meta name=twitter:description content="Ad Password Audit">
<meta name=application-name content="JDTech">
<meta name=apple-mobile-web-app-title content="JDTech"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://hugo.technologify.net/posts/ad-password-audit/><link rel=prev href=https://hugo.technologify.net/posts/tpot/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"AD Password Audit","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/hugo.technologify.net\/posts\/ad-password-audit\/"},"genre":"posts","wordcount":517,"url":"https:\/\/hugo.technologify.net\/posts\/ad-password-audit\/","datePublished":"2022-01-21T21:48:57+11:00","dateModified":"2022-01-21T21:48:57+11:00","publisher":{"@type":"Organization","name":"JD"},"author":{"@type":"Person","name":"JD"},"description":"Ad Password Audit"}</script></head>
<body header-desktop header-mobile><script type=text/javascript>('false'==='true'&&window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=JDTech>JDTech</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> Posts </a><a class=menu-item href=/tags/> Tags </a><a class=menu-item href=/categories/> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=JDTech>JDTech</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><article class="page single"><h1 class="single-title animated flipInX">AD Password Audit</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>JD</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-21>2022-01-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;517 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div>
</div><div class=content id=content><h2 id=problem-statement>Problem Statement</h2>
<p>Accounts with bad passwords, especially accounts with privileged access are the Achilles heel of an organisation’s security. Traditionally IT has tried to impose “strong password policies” such as “Choose a password with an uppercase letter, a number, a symbol and more than 10 characters”. However, a password like “Summer2020!” satisfies ALL those requirements despite being an immesurably weak password.</p>
<p>So, what can we as IT professionals do to reduce bad passwords and mitigate their impact?</p>
<ul>
<li>MFA if possible. Yes, it’s been repeated to the ground but only <a href="https://www.bleepingcomputer.com/news/security/57-percent-of-businesses-use-multi-factor-auth-mfa-says-lastpass/?swcfpc=1#:~:text=Approximately%2057%25%20of%20businesses%20around,on%20data%20from%2047%2C000%20orgs." target=_blank rel="noopener noreferrer">57% percent of organisations use MFA</a>.</li>
<li>Disable Legacy authentication.</li>
<li>Block or limit access to public facing web portals such as OWA, VPN portals and RDweb.</li>
<li>Impose rate limiting and lockout periods for incorrect authentication attempts.</li>
<li>Dectect password spraying across multiple accounts by creating honey accounts with login hours set to nothing and set your SIEM to alert when a login attempt is made for that account.</li>
<li>Audit passwords regularly – I’ll go into more depth later about one way to approach this.</li>
<li>Encourage users to use passphrases. Yes, I do know that passphrases are weak against dictionary attacks, but much like online games, effective strategies change with the “meta” – the current state of the game. At the moment, as most organisations have password policies which encourage 8 character passwords with special characters and numbers, that’s what attackers are expecting.</li>
<li>Reduce the ways attacks can obtain NTLMv2 hashes for offline cracking. I.e. disable LLNMR and NBT-NS, block port 445 egress, don’t use domain admin accounts to login to user workstations, enable windows credential guard, minimise use of office macros.</li>
<li>Password managers – addresses credential reuse and allows for password auditing. I will revisit password managers in another article.</li>
</ul>
<h2 id=how-to-remediate-password-auditing>How to Remediate: Password Auditing</h2>
<p>One very effective way of assessing the current state of passwords in your organisation is to dump the ntds.dat file and run it against common password lists and masks. Note: depending on your org, this may not be allowed as dumping the ntds.dat file containing all user hashes is risky as if an attacker accesses it, they can guess passwords offline.</p>
<ol>
<li>On a domain controller with an elevated Command Prompt run:</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd>ntdsutil <span class=s2>&#34;ac in ntds&#34;</span> <span class=s2>&#34;ifm&#34;</span> <span class=s2>&#34;cr fu c:temp&#34;</span> q q
</code></pre></div><p>Files will be located in C:\Windows\System32\temp</p>
<ol start=2>
<li>
<p>Copy the ntds.dat file to another computer with hashcat installed.</p>
</li>
<li>
<p>Extract the NTLMv2 hashes from the ntds.dat file.</p>
</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>impacket-secretsdump -system registry/SYSTEM -ntds <span class=s2>&#34;Active Directory/ntds.dit&#34;</span> LOCAL -outputfile hashes.txt

<span class=c1>#another option</span>
python3 /opt/impacket/examples/secretsdump.py -system registry/SYSTEM -ntds <span class=s2>&#34;Active Directory/ntds.dit&#34;</span> LOCAL -outputfile hashes.txt
</code></pre></div><ol start=4>
<li>Run hashcat against the hashes.txt file. I had the most success with the “dive.rule” combined with rockyou</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo gzip -d /usr/share/wordlists/rockyou.txt.gz
hashcat -m <span class=m>1000</span> -a <span class=m>0</span> -o cracked.txt hashes.txt /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/dive.rule –force
</code></pre></div><ol start=5>
<li>At the end you can use this awesome tool: <a href=https://github.com/clr2of8/DPAT target=_blank rel="noopener noreferrer">Domain Password Audit Tool (DPAT)</a> created by Carrie Roberts to summarise the results in a neat HTML report.</li>
</ol>
<p>Using a Kali VM on my laptop I managed to crack 50% of our organisation’s passwords! You wouldn’t believe how many people had passwords like and . It was definitely a worthwhile exercise and was an eye-opener for management.</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/ad-password-audit-DPAT.png data-srcset="/ad-password-audit-DPAT.png, /ad-password-audit-DPAT.png 1.5x, /ad-password-audit-DPAT.png 2x" data-sizes=auto alt=/ad-password-audit-DPAT.png title="AD Passwords"></p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2022-01-21</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://hugo.technologify.net/posts/ad-password-audit/ data-title="AD Password Audit"><i class="fab fa-twitter fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/tpot/ class=prev rel=prev title="Creating a Honeypot with T-Pot"><i class="fas fa-angle-left fa-fw"></i>Creating a Honeypot with T-Pot</a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=https://.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>